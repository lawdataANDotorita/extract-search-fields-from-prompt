/**
 * Welcome to Cloudflare Workers! This is your first worker.
 *
 * - Run `npm run dev` in your terminal to start a development server
 * - Open a browser tab at http://localhost:8787/ to see your worker in action
 * - Run `npm run deploy` to publish your worker
 *
 * Learn more at https://developers.cloudflare.com/workers/
 */

import OpenAI from "openai";

const corsHeaders = {
	'Access-Control-Allow-Origin': '*',
	'Access-Control-Allow-Methods': 'POST, OPTIONS',
	'Access-Control-Allow-Headers': 'Content-Type',
	'Content-Type': 'text/event-stream',
	'Cache-Control': 'no-cache',
	'Connection': 'keep-alive'
};

export default {
	async fetch(request, env, ctx) {
		if (request.method === 'OPTIONS') {
			return new Response(null, { headers: corsHeaders });
		}

		let oInputs = { text: "" };
		const contentLength = request.headers.get('content-length');
		if (contentLength && parseInt(contentLength) > 0) {
			oInputs = await request.json();
		}

		const sPrompt = `

אני רוצה לזקק כמה שיותר מידע משפטי מפרומפט שתקבל. 
אני הולך לתאר את סוג המידע שאני מבקש לקבל. אם אין החזר מחרוזת ריקה. אנא החזר את המידע ב-JSON.

מזהה תיק: 
מזהה התיק בדרך כלל מורכב ממספר מחולק ע"י מחיצות בדמות מקפים או לוכסנים. לעיתים יופיע גם סוג תיק שהוא מחרוזת בת שתיים עד ארבע אותיות ויכולה לכלול גרשיים.
אתה אמור להחזיר עד שלושה שדות.
Tik - מזהה של התיק, יכול להופיע כמספר או כשני מספרים שביניהם חוצץ מקף
Tik_Ref - שנת התיק, מופיע אחרי הלוכסן או המקף השני ומכיל שתי ספרות שמייצגות שנה
Tik_Type - סוג התיק. מכיל מחרוזת של שתי אותיות בעברית, לפעמים מופיעים גם גרשיים באמצע. את הגרשיים תמחק מהתוצאה המוחזרת.

דוגמא:
223/14 עא
Tik - 223
Tik_Ref - 14
Tik_Type - עא

דוגמא 2:
13124-15/25 ב"ש
Tik - 13124-15
Tik_Ref - 25
Tik_Type - בש

ערכאה:
ערכאת התיק.

למטה אני מפרט רשימה של ערכאות אפשריות לבחירה. אתה צריך להחזיר רק ערכאה מתוך הרשימה הזו, הערכאה הכי קרובה לערכאה שנמצאת במסמך:
אם לא מצאת ערכאה אל תחזיר ערך.

INTERNATIONAL COURT OF JUSTICE
suprem court of the united states 
בית דין אזורי לעבודה
בית דין למשמעת של עובדי מדינה                     
בית דין למשמעת של רשויות מקומיות                  
בית דין לענייני מים                               
בית דין משמורת של שוהים שלא כדין                  
בית דין צבאי                                      
בית דין רבני                                      
בית דין רבני גדול
בית הדין הארצי לעבודה
בית הדין המשמעתי לשכת עורכי הדין
בית הדין הצבאי לערעורים
בית הדין להגבלים עסקיים                           
בית הדין לחוזים אחידים                            
בית הדין לעררים לפי חוק הכניסה לישראל
בית הדין לשכירות                                  
בית המשפט העליון
בית המשפט הצבאי                                   
בית המשפט לימאות                                  
בית המשפט לענייני משפחה
בית משפט לנוער
בית משפט לעניינים מנהליים                         
בית משפט לעניינים מקומיים                         
בית משפט לתביעות קטנות                            
בית משפט לתעבורה                                  
בית משפט מחוזי
בית משפט שלום
המועצה הארצית לתכנון ובנייה
הממונה על ההגבלים העסקיים                         
המפקח על רישום המקרקעין                           
ועדת אתיקה                                        
ועדת האתיקה של השופטים
ועדת הבחירות המרכזית לכנסת
ועדת הבחירות לכנסת
ועדת הערעורים לפי חוק הנכים                       
ועדת הערר לפי חוק כביש אגרה
ועדת השחרורים                                     
ועדת ערר - שירות קבע
ועדת ערר לענייני ארנונה
ועדת ערר לענייני ביוב
ועדת ערר לפי חוק נתיבים מהירים
ועדת ערר לפיצויים ולהיטל השבחה
ועדת ערר לתכנון ובניה
ועדת ערר מס רכוש
ועדת ערר מס שבח
ועדת ערר תכנון ובניה - ארצי
ועדת ערר תכנון ובניה - מחוזי
ועדת עררים לפי חוק נכי רדיפות הנאצים              
לשכות ההוצאה לפועל                                
מועצת העתונות בישראל                              
מינהלת תנופה
פסיקה זרה                                         
פסקי משקם
רשות השיפוט הארצית                                
רשם האגודות השיתופיות                             
רשם הפטנטים                                       
רשם לענייני ירושה                                 
שונות

דוגמא למיפוי:
בית משפט השלום = בית משפט שלום
בית המשפט המחוזי = בית משפט מחוזי

יכולים להיות עד שלושה שדות של ערכאה:
שם השדה - Arkaa_Type
שם השדה - Arkaa_Type2
שם השדה - Arkaa_Type3


אזור:

אם יש התאמה ישירה בין המחרוזת הנתונה לאזור מהרשימה, החזר את ההתאמה הישירה.
אם לא, בצע חיפוש בהתאמה חלקית.
אם לא מצאת אזור, אל תחזיר ערך.
רשימת אזורים:

אוסטרליה
אילת
ארה"ב
אריאל
ארצי
אשדוד
אשקלון
באר שבע
בית-שאן
בית-שמש
בני-ברק
בריטניה
בת-ים חולון
גבעתיים
דימונה
דנמרק
האיחוד האירופי
הולנד
הרצליה
חדרה
חיפה
טבריה
יהודה
יהודה ושומרון
ירושלים
כפר-סבא
לוד
מחוז דרום
מחוז חיפה
מחוז ירושלים
מחוז מרכז
מחוז צפון
מחוז תל אביב
מסעדה
מעלה אדומים
מרכז
נהריה
נצרת
נתניה
עכו
עפולה
פתח תקוה
צפת
קנדה
קצרין
קריות
קרית ביאליק
קרית גת
קרית שמונה
ראשון לציון
רחובות
רמלה
רמת גן
רמת השרון
רעננה
תל אביב


אם הערכאה היא מסוג בית המשפט העליון או בית דין ארצי לעבודה, אז שדה האזור צריך להישאר ריק.

דוגמאות:

דוגמא 1:
נמצא במסמך: "יהודה"
הערך שאתה מחזיר: "יהודה ושומרון"

דוגמא 2:
נמצא במסמך:"בת-ים"
הערך שאתה מחזיר: "בת-ים חולון"

דוגמא 3:
נמצא במסמך: "מרכז לוד"
הערך שאתה מחזיר: "מרכז"

דוגמא 4:
נמצא במסמך: "תל אביב"
הערך שאתה מחזיר: "תל אביב"

יכולים להיות עד שלושה שדות של אזור:
שם השדה - Ezor
שם השדה - Ezor2
שם השדה - Ezor3

באי כוח:
הפרומפט יכול להכיל גם את באי הכוח, כלומר עו"ד שמייצגים את הצדדים.
שם השדה - OrechDin1

צדדים:
לפעמים הפרומפט יכיל צד אחד או שני או את שניהם. 
שם השדות:
צד א' - Zad1
צד ב' - Zad2


סוג פסק דין:
יכול להיות רק אחד מהערכים הבאים:
גזר דין
החלטה
הכרעת דין
פס"ד
פסק בורר

שם השדה: PsakDin_Type

שופט:
שם השופט/ים.
שם השדה:Shofet

מתאריך:
פסקי דין מתאריך
התאריך יגיע בפורמט של 
dd/mm/yy
או
dd/mm/yyyy
אתה צריך לחלק לשלושה שדות:
D1 - יום
M1 - חודש
Y1 - שנה. את השנה, אם צריך תהפוך לארבע ספרות

עד תאריך:
פסקי דין עד תאריך
התאריך יגיע בפורמט של 
dd/mm/yy
או
dd/mm/yyyy
אתה צריך לחלק לשלושה שדות:
D2 - יום
M2 - חודש
Y2 - שנה. את השנה, אם צריך תהפוך לארבע ספרות

אזכורי חקיקה:
כאשר מופיע אזכור חקיקה ניתן לחלק אותו לשניים:
שם החוק המאוזכר:
שם השדה: IskurHokNm1

שם הסעיף בחוק המאוזכר:
שם השדה: IskurHokSeif1

אזכור פסיקה:
שם השדה: IskurP

טווח החיפוש:
בשדה הזה נציין מה החיפוש יכלול.
בחר את הערך הקרוב ביותר מבין הערכים הבאים:
כל פסקי הדין
פסקי דין שכבר נצפו
פסקי דין שלא נצפו
שם השדה vPsak

חיפוש טקסטואלי:
ייתכן ותקבל טקסט משפטי בשפה טבעית (טקסט שמתאר מקרה, תביעה או אירוע).  
פצל את הטקסט למונחים לצורך הזנה במנוע החיפוש של LawData. כל מונח צריך להתאים לשדה חיפוש נפרד, כלומר – מונח אחד בלבד בכל שדה (אין שימוש ב־"או", אין צרופים מרובי מושגים).
אנא הזן ל(עד) ארבעת שדות החיפוש הבאים, המקיימים ביניהם את היחס הלוגי של 'וגם':
T1
T11
T12
T13

		`;

		const oOpenAi = new OpenAI({
			apiKey: env.OPENAI_API_KEY,
			baseURL: "https://gateway.ai.cloudflare.com/v1/1719b913db6cbf5b9e3267b924244e58/extract-search-fields-from-prompt/openai"
		});

		const messagesForOpenAI = [
			{ role: 'system', content: sPrompt.trim() },
			{ role: 'user', content: oInputs.prompt },
		];

		const chatCompletion = await oOpenAi.chat.completions.create({
			model: "gpt-4.1-mini",
			messages: messagesForOpenAI,
			temperature: 0,
			presence_penalty: 0,
			frequency_penalty: 0,
			stream: false
		});

		const sResponse = chatCompletion.choices?.[0]?.message?.content || "";

		return new Response(sResponse, { headers: corsHeaders });
	}
};
